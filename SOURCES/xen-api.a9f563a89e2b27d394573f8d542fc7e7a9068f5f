commit a9f563a89e2b27d394573f8d542fc7e7a9068f5f
Author: David Scott <dave.scott@citrix.com>
Date:   Thu May 1 14:49:43 2014 +0000

    configure: add '--disable-tests' option
    
    Unfortunately the unit tests don't work when run as unpriviledged
    users inside unprepared chroots. This allows them to be skipped.
    
    By default "./configure && make" will run the unit tests as before.
    
    Signed-off-by: David Scott <dave.scott@citrix.com>

diff --git a/Makefile b/Makefile
index 5b775f9..b712035 100644
--- a/Makefile
+++ b/Makefile
@@ -35,7 +35,9 @@ all: version
 	omake -j 8 phase1
 	omake -j 8 phase2
 	omake -j 8 phase3
+ifeq ($(DISABLE_TESTS),false)
 	@make test
+endif
 
 .PHONY: phase3
 phase3:
diff --git a/configure b/configure
index 034cfdd..ba095e6 100755
--- a/configure
+++ b/configure
@@ -17,6 +17,10 @@ let path name default docv doc =
   let doc = Printf.sprintf "Set the path for %s" doc in
   Arg.(value & opt string default & info [name] ~docv ~doc)
 
+let disable_tests =
+  let doc = "Disable the unit tests" in
+  Arg.(value & flag & info [ "disable-tests" ] ~doc)
+
 let varpatchdir = dir "varpatchdir" "/var/patch" "VARPATCHDIR" "hotfixes"
 let etcdir = dir "etcdir" "/etc/xensource" "ETCDIR" "configuration files"
 let optdir = dir "optdir" "/opt/xensource" "OPTDIR" "system files"
@@ -43,13 +47,14 @@ let output_file filename lines =
   List.iter (output_string oc) lines;
   close_out oc
 
-let configure varpatchdir etcdir optdir plugindir hooksdir inventory xapiconf libexecdir scriptsdir sharedir webdir xhadir bindir sbindir udevdir =
-  Printf.printf "Configuring with the following params:\n\tvarpatchdir=%s\n\tetcdir=%s\n\toptdir=%s\n\tplugindir=%s\n\thooksdir=%s\n\tinventory=%s\n\txapiconf=%s\n\tlibexecdir=%s\n\tscriptsdir=%s\n\tsharedir=%s\n\twebdir=%s\n\txhadir=%s\n\tbindir=%s\n\tsbindir=%s\n\tudevdir=%s\n\n" varpatchdir etcdir optdir plugindir hooksdir inventory xapiconf libexecdir scriptsdir sharedir webdir xhadir bindir sbindir udevdir;
+let configure disable_tests varpatchdir etcdir optdir plugindir hooksdir inventory xapiconf libexecdir scriptsdir sharedir webdir xhadir bindir sbindir udevdir =
+  Printf.printf "Configuring with the following params:\n\tdisable_tests=%b\n\tvarpatchdir=%s\n\tetcdir=%s\n\toptdir=%s\n\tplugindir=%s\n\thooksdir=%s\n\tinventory=%s\n\txapiconf=%s\n\tlibexecdir=%s\n\tscriptsdir=%s\n\tsharedir=%s\n\twebdir=%s\n\txhadir=%s\n\tbindir=%s\n\tsbindir=%s\n\tudevdir=%s\n\n" disable_tests varpatchdir etcdir optdir plugindir hooksdir inventory xapiconf libexecdir scriptsdir sharedir webdir xhadir bindir sbindir udevdir;
 
   (* Write config.mk *)
   let lines = 
     [ "# Warning - this file is autogenerated by the configure script";
       "# Do not edit";
+      Printf.sprintf "DISABLE_TESTS=%b" disable_tests;
       Printf.sprintf "VARPATCHDIR=%s" varpatchdir;
       Printf.sprintf "ETCDIR=%s" etcdir;
       Printf.sprintf "OPTDIR=%s" optdir;
@@ -88,7 +93,7 @@ let configure varpatchdir etcdir optdir plugindir hooksdir inventory xapiconf li
   in
   output_file fhs_ml fhs_lines
 
-let configure_t = Term.(pure configure $ varpatchdir $ etcdir $ optdir $ plugindir $ hooksdir $ inventory $ xapiconf $ libexecdir $ scriptsdir $ sharedir $ webdir $ xhadir $ bindir $ sbindir $ udevdir )
+let configure_t = Term.(pure configure $ disable_tests $ varpatchdir $ etcdir $ optdir $ plugindir $ hooksdir $ inventory $ xapiconf $ libexecdir $ scriptsdir $ sharedir $ webdir $ xhadir $ bindir $ sbindir $ udevdir )
 
 let () = 
   match 
